# Проектирование высоконагруженных систем
## Notion

## Содержание
[1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)

[2. Расчет нагрузки](#2-расчет-нагрузки)

## 1. Тема и целевая аудитория
Notion - это сервис для создания заметок и текстовых документов, канбан-карт, гибких баз данных и баз знаний, трекинга задач и управления проектами.

### Функционал MVP:
- авторизация
- профиль пользователя
- главная страница
- создание и редактирование контента
- поиск по страницам
- недавние и избранные страницы
- вложенные страницы с иерархией
- прикрепление вложений
- ACL, права доступа
- шеринг по ссылке/почте

### Целевая аудитория
По данным сайта [hypestat](https://hypestat.com/info/notion.so) Notion имеет следующие метрики:
- более 5 млн уникальных пользователей в день (DAU)
- более 25 млн уникальных пользователей в месяц (MAU) и 170 млн сессий в месяц (~7 визитов на пользователя)
- около 20% пользователей заходят в сервис ежедневно (stickness, DAU/MAU)
- среднее время сессии пользователя - 9 минут
- в среднем пользователь за сессию просматривает около 10 страниц
- bounce rate сервиса - около 25% пользователей покидают сайт, не совершая никаких взаимодействий

## Анализ аудитории

#### География пользователей
![img.png](images/user_geography.png)

#### Устройства пользователей
![img.png](images/devices.png)

## 2. Расчет нагрузки

По данным сайта [hypestat](https://hypestat.com/info/notion.so) значение DAU равно 5 млн, MAU - 25 млн.

### Расчет объема сохраняемых данных
В 2024 году [Notion](https://www.notion.com/blog/100-million-of-you) достиг отметки 100 млн пользователей. Исходя из этого можно оценить объем сохраняемых данных.
В расчётах я предполагаю, что Notion прибавляет +0.5 млн пользователей в месяц. Это даёт примерно:

$$
\frac{500\,000}{30} \approx 16\,667\ \text{новых пользователей в день}
$$

**Прирост в день (единицы):**

$$
\text{ед/день} =
\text{ед/пользователя} \times \text{новых пользователей в день}
$$

**Прирост в день (объём):**

$$
\text{объем/день} =
\text{ед/день} \times \text{средний размер единицы}
$$


**Прирост в месяц (единицы):**

$$
\text{ед/мес} =
\text{ед/пользователя} \times \text{новых пользователей в месяц}
$$


**Прирост в месяц (объём):**

$$
\text{объем/мес} =
\text{ед/мес} \times \text{средний размер единицы}
$$

| Хранимые данные         | Средний размер единицы | Ед/пользователя | Сколько единиц | Суммарный объем | Прирост в день | Прирост в месяц |
|-------------------------|------------------------|:---------------:|----------------|-----------------|----------------|-----------------|
| профиль пользователя    | 300 КБ                 |        1        | 100 млн        | 30 ТБ           | 5 ГБ           | 135 ГБ          |
| страницы (без вложений) | 200 КБ (~25k слов)     |       10        | 1 млрд         | 200 ТБ          | 33 ГБ          | 1.0 ТБ          |
| вложения                | 1 МБ                   |       40        | 4 млрд         | 4 ПБ            | 0.68 ТБ        | 20 ТБ           |
| **Итого**               | —                      |        —        | —              | **4.23 ПБ**     | **0.72 ТБ**    | **21 ТБ**       |

Суммарный объем данных составляет 4230 Тб, из которых 4000 Тб - хранилище вложений.

### Расчет среднего количества действий пользователя в день и RPS
Публичных данных по действиям пользователя в день нет, поэтому я опираюсь на свой опыт использования Notion и агрегированные метрики с [hypestat](https://hypestat.com/info/notion.so). Пользователь в среднем просматривает ~9.5 страниц за сессию. Примем, что у пользователя примерно 4 сессии в день, тогда в среднем это около 38 страниц в день. Эти страницы формируются из нескольких типов действий:
- **посещение домашней страницы** — точка входа, где отображаются список собственных страниц, недавние и избранные;
- **поиск по страницам** — часть навигации, которая открывает нужный документ;
- **просмотры контента** — собственно загрузка страниц с данными и вложениями, кроме домашней.

Для расчета RPS будем использовать формулу

$$RPS = \frac{\text{среднее действий в день на пользователя} \times DAU}{86\,400}$$

| Действие                                              | Среднее в день на пользователя |  RPS |
|-------------------------------------------------------|:------------------------------:|-----:|
| посещение домашней страницы                           |              12                |  694 |
| создание страницы                                     |               1                |   58 |
| поиск страниц                                         |              6.5               |  376 |
| регистрация/авторизация                               |              0.1               |    6 |
| редактирование страницы (автосохранение – 5 сек, 15 мин) |            180               | 10417 |
| просмотр страницы                                     |              30                | 1736 |
| прикрепление вложений                                 |              2.5               |  145 |
| изменение прав доступа (ACL)                          |              0.6               |   35 |
| профиль пользователя                                  |              0.2               |   12 |
| шеринг по ссылке/почте                                |              0.4               |   23 |

В результате расчётов получаем средний RPS ≈ 13 500. Для оценки пиков учтем, что пользователи находятся в разных часовых поясах, поэтому пики нагрузки распределены, но всё же заметно превышают среднее значение. Примем коэффициент RPS×2.0 для перехода от среднего к пиковому значению. Итого, расчётная пиковая нагрузка ≈ 27 000 RPS.

### Расчет сетевого трафика

Для оценки сетевой нагрузки можно ориентироваться на замеры в инструментах разработчика браузера (DevTools). Суммарную нагрузку на сеть считаем по формуле:

$$
\text{Нагрузка [Гбит/с]} =
\frac{\text{средний трафик на действие [КБ]} \times RPS \times 8}
{1024 \times 1024}
$$

| Действие                                   | КБ на действие |   RPS  | Нагрузка (Гбит/с) | Нагрузка (Гбит/день) |
|--------------------------------------------|:--------------:|------:|------------------:|---------------------:|
| посещение домашней страницы                |      550       |   694 |             2.91  |            251 609   |
| создание страницы                          |       50       |    58 |             0.02  |              1 912   |
| поиск страниц                              |      370       |   376 |             1.06  |             91 705   |
| регистрация/авторизация                    |       80       |     6 |             0.00  |                316   |
| редактирование страницы (автосохранение)   |       50       | 10 417|             3.97  |            343 334   |
| просмотр страницы                          |      350       | 1 736 |             4.64  |            400 518   |
| прикрепление вложений                      |      100       |   145 |             0.11  |              9 558   |
| изменение прав доступа (ACL)               |       30       |    35 |             0.01  |                692   |
| профиль пользователя                       |       10       |    12 |             0.00  |                 79   |
| шеринг по ссылке/почте                     |       80       |    23 |             0.01  |              1 213   |

$$
\text{Средняя нагрузка на сеть} \approx 12.74\ \text{Гбит/с}
$$

$$
\text{Суточная нагрузка на сеть} =
12.74 \times 86\,400 \approx 1\,100\,936\ \text{Гбит/день}
\approx 137.6\ \text{ТБ/день}
$$

$$
\text{Трафик на пользователя в день} =
12 \times 550 +
1 \times 50 +
6.5 \times 370 +
0.1 \times 80 +
180 \times 50 +
30 \times 350 +
2.5 \times 100 +
0.6 \times 30 +
0.2 \times 10 +
0.4 \times 80
$$

$$
\approx 10{,}040\ \text{КБ/день}
\approx 0.078\ \text{Гбит/день на пользователя}
$$

**Пиковый коэффициент**

Пиковый коэффициент показывает, во сколько раз пиковая нагрузка превышает среднюю:

$$
k_{\text{пик}} = \frac{\text{Пиковая нагрузка}}{\text{Средняя нагрузка}}
$$

Сделаем допущение: поскольку Notion — это B2B SaaS-сервис, примем

$$
k_{\text{пик}} = 2
$$

Тогда:

$$
\text{Пиковая нагрузка} =
\text{Средняя нагрузка} \times k_{\text{пик}}
= 12.74 \times 2 \approx 25.5\ \text{Гбит/с}
$$

---

**Коэффициент надежности**

Коэффициент надежности показывает, какой запас ресурсов закладывается в системе:

$$
k_{\text{надёжн}} = \frac{\text{Доступные ресурсы}}{\text{Необходимые ресурсы}}
$$

Для критичного сервиса уровня Notion примем

$$
k_{\text{надёжн}} = 1.25
$$

Тогда:

$$
\text{Нагрузка с резервом} =
\text{Пиковая нагрузка} \times k_{\text{надёжн}}
= 25.5 \times 1.25 \approx 32\ \text{Гбит/с}
$$
