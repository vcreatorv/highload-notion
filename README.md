# Проектирование высоконагруженных систем
## Notion

## Содержание
[1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)

[2. Расчет нагрузки](#2-расчет-нагрузки)

[3. Глобальная балансировка нагрузки](#3-глобальная-балансировка-нагрузки)

[4. Локальная балансировка нагрузки](#4-локальная-балансировка-нагрузки)

[5. Логическая схема БД](#5-логическая-схема-бд)

[6. Физическая схема БД](#6-физическая-схема-бд)

## 1. Тема и целевая аудитория
Notion - это сервис для создания заметок и текстовых документов, канбан-карт, гибких баз данных и баз знаний, трекинга задач и управления проектами.

### Функционал MVP:
- авторизация
- профиль пользователя
- главная страница
- создание и редактирование контента
- поиск по страницам
- недавние и избранные страницы
- вложенные страницы с иерархией
- прикрепление вложений
- ACL, права доступа
- шеринг по ссылке/почте
- количество просмотров страницы

### Целевая аудитория
По данным сайта [hypestat](https://hypestat.com/info/notion.so) Notion имеет следующие метрики:
- более 5 млн уникальных пользователей в день (DAU)
- более 25 млн уникальных пользователей в месяц (MAU) и 170 млн сессий в месяц (~7 визитов на пользователя)
- около 20% пользователей заходят в сервис ежедневно (stickness, DAU/MAU)
- среднее время сессии пользователя - 9 минут
- в среднем пользователь за сессию просматривает около 10 страниц
- bounce rate сервиса - около 25% пользователей покидают сайт, не совершая никаких взаимодействий

## Анализ аудитории

#### География пользователей
![img.png](images/user_geography.png)

#### Устройства пользователей
![img.png](images/devices.png)

## 2. Расчет нагрузки

По данным сайта [hypestat](https://hypestat.com/info/notion.so) значение DAU равно 5 млн, MAU - 25 млн.

### Расчет объема сохраняемых данных
В 2024 году [Notion](https://www.notion.com/blog/100-million-of-you) достиг отметки 100 млн пользователей. Исходя из этого можно оценить объем сохраняемых данных.
В расчётах я предполагаю, что Notion прибавляет +0.5 млн пользователей в месяц. Это даёт примерно:

$$
\frac{500\,000}{30} \approx 16\,667\ \text{новых пользователей в день}
$$

**Прирост в день (единицы):**

$$
\text{ед/день} =
\text{ед/пользователя} \times \text{новых пользователей в день}
$$

**Прирост в день (объём):**

$$
\text{объем/день} =
\text{ед/день} \times \text{средний размер единицы}
$$


**Прирост в месяц (единицы):**

$$
\text{ед/мес} =
\text{ед/пользователя} \times \text{новых пользователей в месяц}
$$


**Прирост в месяц (объём):**

$$
\text{объем/мес} =
\text{ед/мес} \times \text{средний размер единицы}
$$

| Хранимые данные         | Средний размер единицы | Ед/пользователя | Сколько единиц | Суммарный объем | Прирост в день | Прирост в месяц |
|-------------------------|------------------------|:---------------:|----------------|-----------------|----------------|-----------------|
| профиль пользователя    | 300 КБ                 |        1        | 100 млн        | 30 ТБ           | 5 ГБ           | 135 ГБ          |
| страницы (без вложений) | 200 КБ (~25k слов)     |       10        | 1 млрд         | 200 ТБ          | 33 ГБ          | 1.0 ТБ          |
| вложения                | 1 МБ                   |       40        | 4 млрд         | 4 ПБ            | 0.68 ТБ        | 20 ТБ           |
| **Итого**               | —                      |        —        | —              | **4.23 ПБ**     | **0.72 ТБ**    | **21 ТБ**       |

Суммарный объем данных составляет 4230 Тб, из которых 4000 Тб - хранилище вложений.

### Расчет среднего количества действий пользователя в день и RPS
Публичных данных по действиям пользователя в день нет, поэтому я опираюсь на свой опыт использования Notion и агрегированные метрики с [hypestat](https://hypestat.com/info/notion.so). Пользователь в среднем просматривает ~9.5 страниц за сессию. Примем, что у пользователя примерно 4 сессии в день, тогда в среднем это около 38 страниц в день. Эти страницы формируются из нескольких типов действий:
- **посещение домашней страницы** — точка входа, где отображаются список собственных страниц, недавние и избранные;
- **поиск по страницам** — часть навигации, которая открывает нужный документ;
- **просмотры контента** — собственно загрузка страниц с данными и вложениями, кроме домашней.

Для расчета RPS будем использовать формулу

$$RPS = \frac{\text{среднее действий в день на пользователя} \times DAU}{86\,400}$$

| Действие                                              | Среднее в день на пользователя |  RPS |
|-------------------------------------------------------|:------------------------------:|-----:|
| посещение домашней страницы                           |              12                |  694 |
| создание страницы                                     |               1                |   58 |
| поиск страниц                                         |              6.5               |  376 |
| регистрация/авторизация                               |              0.1               |    6 |
| редактирование страницы (автосохранение – 5 сек, 15 мин) |            180              | 10417|
| просмотр страницы                                     |              30                | 1736 |
| прикрепление вложений                                 |              2.5               |  145 |
| изменение прав доступа (ACL)                          |              0.6               |   35 |
| профиль пользователя                                  |              0.2               |   12 |
| шеринг по ссылке/почте                                |              0.4               |   23 |
| инкремент просмотров страницы                         |              30                | 1736 |
| получение медиа контента                              |              120               | 6944 |

### Расчет сетевого трафика

Для оценки сетевой нагрузки можно ориентироваться на замеры в инструментах разработчика браузера (DevTools). Суммарную нагрузку на сеть считаем по формуле:

$$
\text{Нагрузка [Гбит/с]} =
\frac{\text{средний трафик на действие [КБ]} \times RPS \times 8}
{1024 \times 1024}
$$

| Действие                                   | КБ на действие |   RPS  | Нагрузка (Гбит/с) | Нагрузка (Гбит/день) |
|--------------------------------------------|:--------------:|------:|------------------:|---------------------:|
| посещение домашней страницы                |      550       |   694 |             2.91  |            251 609   |
| создание страницы                          |       50       |    58 |             0.02  |              1 912   |
| поиск страниц                              |      370       |   376 |             1.06  |             91 705   |
| регистрация/авторизация                    |       80       |     6 |             0.00  |                316   |
| редактирование страницы (автосохранение)   |       50       | 10 417|             3.97  |            343 334   |
| просмотр страницы                          |      350       | 1 736 |             4.64  |            400 518   |
| прикрепление вложений                      |      100       |   145 |             0.11  |              9 558   |
| изменение прав доступа (ACL)               |       30       |    35 |             0.01  |                692   |
| профиль пользователя                       |       10       |    12 |             0.00  |                 79   |
| шеринг по ссылке/почте                     |       80       |    23 |             0.01  |              1 213   |
| инкремент просмотров страницы              |       1        |  1736 |            0.0133 |               1,145  |
| получение медиа контента                   |       8        |  6944 |            0.4283 |              36 616  |

$$
\text{Средняя нагрузка на сеть} \approx 13.18\ \text{Гбит/с}
$$

$$
\text{Суточная нагрузка на сеть} =
13.18 \times 86\,400 \approx 1\,100\,936\ \text{Гбит/день}
\approx 139\ \text{ТБ/день}
$$

$$
\text{Трафик на пользователя в день} =
12 \times 550 +
1 \times 50 +
6.5 \times 370 +
0.1 \times 80 +
180 \times 50 +
30 \times 350 +
2.5 \times 100 +
0.6 \times 30 +
0.2 \times 10 +
0.4 \times 80 +
120 \times 8 
$$

$$
\approx 11{,}000\ \text{КБ/день}
\approx 0.084\ \text{Гбит/день на пользователя}
$$

**Пиковый коэффициент**

Пиковый коэффициент показывает, во сколько раз пиковая нагрузка превышает среднюю:

$$
k_{\text{пик}} = \frac{\text{Пиковая нагрузка}}{\text{Средняя нагрузка}}
$$

Сделаем допущение: поскольку Notion — это B2B SaaS-сервис, примем

$$
k_{\text{пик}} = 2
$$

Тогда:

$$
\text{Пиковая нагрузка} =
\text{Средняя нагрузка} \times k_{\text{пик}}
= 13.18 \times 2 \approx 26.4\ \text{Гбит/с}
$$

**Коэффициент надежности**

Коэффициент надежности показывает, какой запас ресурсов закладывается в системе:

$$
k_{\text{надёжн}} = \frac{\text{Доступные ресурсы}}{\text{Необходимые ресурсы}}
$$

Для критичного сервиса уровня Notion примем

$$
k_{\text{надёжн}} = 1.25
$$

Тогда:

$$
\text{Нагрузка с резервом} =
\text{Пиковая нагрузка} \times k_{\text{надёжн}}
= 26.4 \times 1.25 \approx 33\ \text{Гбит/с}
$$

## 3. Глобальная балансировка нагрузки
Глобальная балансировка нагрузки — это распределение трафика между несколькими географически разнесёнными дата-центрами.

Для размещения дата-центров использовалась статистика по распределению пользователей (см. [пункт 1](#1-тема-и-целевая-аудитория)). Наибольшая доля аудитории сосредоточена в США, Южной Корее, Японии, Бразилии и странах Европы. Поэтому ЦОДы расположены в регионах с высокой концентрацией пользователей и развитой технологической инфраструктурой. Дополнительно при выборе городов учитывалась [карта плотности населения мира](https://luminocity3d.org/WorldPopDen/#3/20.00/10.00).


### 1. США
16.2% аудитории (≈1 млн DAU) находится в США. Это крупнейший рынок, поэтому здесь необходимо разместить несколько ЦОДов. Они распределяются по географии страны:  
- **Сиэтл** — северо-запад, технологический центр и крупный кластер облачных провайдеров (AWS, Azure, Google Cloud).  
- **Финикс и Даллас** — юго-запад и центр, регионы с низкой стоимостью электроэнергии и высокой концентрацией дата-центров.  
- **Вирджиния** — восточное побережье, крупнейший в мире хаб дата-центров (Ashburn).  

Такое распределение позволяет минимизировать задержки для пользователей по всей территории США

![usa.png](images/usa.png)

### 2. Южная Корея и Япония
На Корею (11.5%) и Японию (10.3%) суммарно приходится более 20% пользователей (≈1 млн DAU). Благодаря компактной территории, достаточно по одному ЦОДу в каждой стране:  
- **Сеул** — крупнейший технологический и сетевой центр Кореи.  
- **Токио** — основная агломерация Японии, откуда обеспечивается низкая задержка для всей страны.  

Дополнительно в регионе выбран **Пекин**: это позволяет обслуживать пользователей Китая и частично разгрузить трафик из Японии и Кореи.

![asia.png](images/asia.png)

### 3. Бразилия
Бразилия даёт около 7% аудитории (≈350 тыс. DAU). Несмотря на огромную территорию страны, большая часть населения сосредоточена на атлантическом побережье. Поэтому логично разместить один ЦОД в **Сан-Паулу** — крупнейшем финансовом и технологическом центре региона. Этого достаточно, так как общее количество пользователей в Латинской Америке относительно невелико.

![brazil.png](images/brazil.png)

### 4. Европа и Россия
Франция (4.1%) и остальные страны Европы дают совокупно более 50% аудитории. Пользователи в Европе в основном концентрируются в столицах и крупных городах. Поэтому для покрытия региона выбраны:  
- **Лондон** — один из крупнейших европейских телеком-хабов.  
- **Париж** — столица Франции и важный дата-центр регионального уровня.  
- **Москва и Новосибирск** — для покрытия Восточной Европы и России. Несмотря на санкции, пользователи продолжают оставаться, поэтому для них логично оставить инфраструктуру в крупных городах.  

![europe.png](images/europe.png)


### 5. Южная Азия, Африка и Австралия
Хотя прямой статистики меньше, на эти регионы приходится значительная часть мирового населения. Чтобы обеспечить базовый уровень доступности для пользователей предлагается разместить ЦОДы в:  
- **Мумбаи** — крупнейший технологический и телеком-центр Индии.  
- **Каир** — важный хаб для Северной Африки и Ближнего Востока.  
- **Йоханнесбург** — основной телеком-центр Южной Африки.  
- **Сидней** — логичный выбор для Австралии и Океании.


![others.png](images/others.png)

Полную карту можно посмотреть по [ссылке](https://yandex.ru/maps/?um=constructor%3Ad36b173e069ce28964f230d783d100a1960bf874ec14b7b1728ffeba17027420&source=constructorLink)

### CDN

Чтобы сократить время загрузки интерфейсов и статического контента, задействуем CDN. Сеть доставки контента кэширует изображения, скрипты и вложения на узлах, расположенных ближе к пользователю. Это уменьшает нагрузку на дата-центры и ускоряет работу сервиса.

### BGP Anycast

Для глобальной маршрутизации запросов в каждом регионе будет применяться BGP Anycast. Один и тот же IP-адрес будет анонсироваться из разных дата-центров, и с помощью маршрутизации автоматически направит пользователя в ближайший доступный узел. Это снижает сетевые задержки и повышает отказоустойчивость системы.

[BGP](https://asvk.cs.msu.ru/~sveta/8-2-BGP.pdf) (Border Gateway Protocol) — это протокол маршрутизации, предназначенный для обмена информацией о сетях между автономными системами (AS). Автономная система — это совокупность маршрутизаторов, находящихся под единым административным управлением и использующих общую внутреннюю политику маршрутизации (например, сеть провайдера или крупной организации). В отличие от внутренних протоколов маршрутизации, которые ориентируются в основном на количественные метрики (например, длину пути в количестве переходов), BGP реализует так называемый path-vector-подход: каждый анонс маршрута сопровождается набором атрибутов, которые описывают свойства пути и позволяют принимать решения в соответствии с политиками конкретной автономной системы.

Выбор маршрута в BGP опирается на несколько ключевых атрибутов: weight, LOCAL_PREF, AS_PATH, ORIGIN, MED, NEXT_HOP, ATOMIC_AGGREGATE, AGGREGATOR.

Anycast — сетевая технология, при которой один IP-адрес назначается нескольким серверам. В отличие от Multicast или Broadcast, пакет, направленный на этот IP адрес, дойдёт не до всех серверов, а до одного.

## 4. Локальная балансировка нагрузки
Локальная балансировка нагрузки работает внутри конкретного дата-центра и распределяет трафик между несколькими серверами или сервисами в одном месте.

После того как трафик попал в площадку, его принимает **Kubernetes Service**. Он выполняет роль L4-балансировщика, распределяя TCP/UDP-соединения между нодами, на которых запущены ingress-поды (с Envoy). Для этого используется встроенный kube-proxy, который опирается на актуальную информацию о нодах и подах из Kubernetes API.

Помимо балансировки, Kubernetes:
- автоматически перезапускает упавшие контейнеры, обеспечивая отказоустойчивость;
- распределяет и перераспределяет нагрузку между нодами за счёт планировщика;
- является стандартом индустрии для управления контейнеризированными сервисами.

### Envoy

Для балансировки и маршрутизации на уровне приложений используется связка Envoy + Envoy Assist. Ingress-поды с Envoy принимают входящие HTTPS-соединения, терминируют SSL и анализируют HTTP-запросы. На основе конфигурации и алгоритма **least connections** Envoy выбирает backend-pod из пула доступных реплик.

### Envoy Assist

- собирает актуальную информацию о подах и сервисах;
- обновляет конфигурацию Envoy динамически, когда меняется количество реплик или состояние подов;
- обеспечивает стабильную и гибкую маршрутизацию без ручных правок конфигов.

### Терминация SSL

- терминация SSL выполняется на ingress Envoy — на границе кластера;
- дополнительно каждый микросервис принимает HTTPS-соединения, что даёт сквозное шифрование и контроль соединений во внутренней сети.

## 5. Логическая схема БД

![img.png](images/erd.jpg)

| Таблица             | Описание                                                                                                                                                                                                                                                                                                                                                   |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **User**            | Хранит аккаунты пользователей: email/username, имя, хэш пароля, аватар (URL), даты создания/обновления. Используется как владелец страниц и субъект ACL.                                                                                                                                                                                                   |
| **Page**            | Страницы (узлы иерархии). Хранит заголовок, **content** (JSONB — содержимое без учёта вложений), `parent_id` (ссылка на родителя), а также **`subpages`** (JSONB-кэш вида `[{subpage_id: title}, …]` для быстрого отображения списка дочерних страниц). Поле `version` — **последняя материализованная** версия (до какого `seq` применён контент).        |
| **Attachment**      | Метаданные вложений страницы: ссылка на страницу, URL файла в объектном хранилище (S3), дата создания. Сами файлы лежат во внешнем S3.                                                                                                                                                                                                                 |
| **ACL**             | Права доступа к страницам: для пары (`page_id`, `user_id`) хранит флаги `can_read`/`can_write`, а также временные метки. Определяет, кто может читать/редактировать страницу.                                                                                                                                                                              |
| **Version**         | Таблица версионирования **1-к-1** со `Page`. Содержит **`last_processed_version`** — «голову» журнала (последний выданный `seq`) и `updated_at`. Используется для атомарного присвоения `seq` на приёме операции.                                                                                                                                          |
| **Pending_Version** | **Журнал принятых операций**: хранит `(page_id, seq)` порядок, `op_id` (идемпотентность), `user_id` (автор), `user_seq` (версия клиента). |
| **Share_Link**      | Шеринг страницы по ссылке/почте: хранит токен (внешняя ссылка), разрешения (`can_read`, `can_write`) и срок действия. Привязан к `page_id`.                                                                                                                                                                                                                |
| **Page_View**       | Счётчик просмотров страницы: агрегирует общее число просмотров (`total`) для `page_id`.                                                                                                                                                                                                                     |
| **Favourite**       | Избранные страницы пользователя: связи `user_id` ↔ `page_id` с датой добавления. Для раздела «Избранное».                                                                                                                                                                                                                                                  |
| **Recent**          | Недавние страницы пользователя: хранит `user_id`, `page_id`, и `last_opened_at` (последнее открытие) для формирования раздела «Недавние».                                                                                                                                                                                                                  |

### Ключевые моменты
- Контент страницы — JSONB (без вложений), лимит 300 КБ. Держим структурированный JSON, что позволяет делать частичные обновления по путям, хранить порядок и стили, и не тащить вложения внутрь `content`.
- Вложения — S3, лимит 1 МБ на файл. В базе храним только метаданные (Attachment), сами файлы — в объектном хранилище.
- Иерархия страниц — для быстрого рендера у родителя храним subpages (JSON-кэш вида `[{subpage_id: title}, …]`). «Истина» в `parent_id`, кэш у родителя. Кэш обновляется асинхронно по событиям при изменении заголовка/родителя.
- Редактирование — «журнал операций» + версии. Операции записываются в таблицу `pending_version(page_id, seq, op_id, user_id, user_seq, op_json)`. Счётчик версии хранится в `version.last_processed_version` (монотонный `seq`).

Как происходит версионирование:
- Клиент отправляет правку вместе с номером версии, на которой он редактировал (`user_seq`) и уникальным `op_id`.
- Сервер присваивает новый `seq` (увеличивает `version.last_processed_version`) и записывает операцию в `pending_version` с этим `seq`. Если клиент немного отстал, сервер корректирует позиции правки с учётом уже принятых операций и всё равно принимает её.
- Клиент получает подтверждение с присвоенным `seq`.
- Фоновый воркер периодически применяет диапазон операций `[Page.version+1 … last_processed_version]` к `Page.content` и одним апдейтом поднимает `Page.version`.
- Хранение головы журнала. `version.last_processed_version` — источник истины для текущего номера версии страницы; `Page.version` показывает, до какого seq контент уже применён.

Формат `op_json`

```json
{
  "v": 123,          // назначенный сервером seq (дублирует колонку seq для удобства клиентов)
  "o": "insert",     // тип: insert | delete | format
  "p": 5,            // позиция (для insert/delete) или начало диапазона
  "d": "hello",      // данные (для insert), опционально
  "len": 3,          // длина (для delete), опционально
  "range": [5,12],   // диапазон (для format), опционально
  "style": {"bold": true}, // атрибуты стиля (для format), опционально
}
```

### Размер данных

**User**

- id: 32 байт

- email: 64 байт

- username: 20 байт

- first_name: 20 байт

- last_name: 30 байт

- password_hash: 256 байт

- avatar_url: 128 байт

- created_at: 8 байт

- updated_at: 8 байт

  Итого: 100 млн пользователей × 566 байт → 56.6 Гб

**Page**

- id: 32 байт

- title: 64 байт

- content: 256000 байт (контент без вложений, лимит для MVP)

- subpages: ~(100 байт × 3 дочерних) → 300 байт

- parent_id: 32 байт

- owner_id: 32 байт

- version (BIGINT): 8 байт

- created_at: 8 байт

- updated_at: 8 байт

  Итого: 1 млрд страниц × 256 484 байт → ~256.5 Тб

**Attachment**

- id: 32 байт

- page_id: 32 байт

- url: 128 байт

- created_at: 8 байт

  Итого: 4 млрд аттачей × 200 байт → ~800 Гб (сами файлы лежат в S3 и сюда не входят)

**ACL**

- id: 32 байт

- user_id: 32 байт

- page_id: 32 байт

- can_read: 1 байт

- can_write: 1 байт

- created_at: 8 байт

- updated_at: 8 байт

  Итого: ~ (1 млрд страниц × 5 записей) = 5 млрд × 114 байт → ~570 Гб

**Version**

- id: 32 байт

- page_id: 32 байт

- last_processed_version: 8 байт

- updated_at: 8 байт

  Итого: 1 млрд строк × 80 байт → ~80 Гб

**Pending_Version**

- page_id: 32 байт

- seq: 8 байт

- op_id: 32 байт

- user_id: 32 байт

- base_seq: 8 байт

- op_json: ~80 байт

- created_at: 8 байт

  Итого (скользящее окно журнала): ≈ (10 417 ops/s × 1 800 s) = 18.75 млн строк × ~200 байт → ~3.75 Гб (окно 30 минут; при 10 мин будет ~1.25 Гб; при 24 час — ~180 Гб)

**Share_Link**

- id: 32 байт

- page_id: 32 байт

- can_read: 1 байт

- can_write: 1 байт

- expires_at: 8 байт

- created_at: 8 байт

Итого: ~(0.1 × 1 млрд) = 100 млн × 82 байт → ~8.2 Гб

**Page_View**

- id: 32 байт

- page_id: 32 байт

- total (BIGINT): 8 байт

Итого: 1 млрд × 72 байт → ~72 Гб

**Favourite**

- id: 32 байт

- page_id: 32 байт

- user_id: 32 байт

- created_at: 8 байт

  Итого: ~(5 × 100 млн) = 500 млн × 104 байт → ~52 Гб

**Recent**

- id: 32 байт

- page_id: 32 байт

- user_id: 32 байт

- last_opened_at: 8 байт

  Итого: ~(10 × 100 млн) = 1 млрд × 104 байт → ~104 Гб

### Требования к консистентности

| Таблица             | Консистентность                                                 |
| ------------------- | --------------------------------------------------------------- |
| **User**            | Strong                                                     |
| **Page**            | Sequential / Causal                                         |
| **Attachment**      | Strong (мета в БД) / Eventual (доступ к файлу в S3) |
| **ACL**             | Strong                                                      |
| **Version**         | Strong                                                      |
| **Pending_Version** | Sequential / Causal                                         |
| **Share_Link**      | Strong                                                    |
| **Page_View**       | Eventual                                                   |
| **Favourite**       | Sequential / Causal                                        |
| **Recent**          | Eventual                                                    |

