# Проектирование высоконагруженных систем
## Notion

## Содержание
[1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория)

## 1. Тема и целевая аудитория
Notion - это сервис для создания заметок и текстовых документов, канбан-карт, гибких баз данных и баз знаний, трекинга задач и управления проектами.

### Функционал MVP:
- авторизация
- профиль пользователя
- главная страница
- создание и редактирование контента
- поиск по страницам
- недавние и избранные страницы
- вложенные страницы с иерархией
- прикрепление вложений
- автосохранение
- ACL, права доступа

### Целевая аудитория
По данным сайта [hypestat](https://hypestat.com/info/notion.so) Notion имеет следующие метрики:
- более 5 млн уникальных пользователей в день (DAU)
- более 25 млн уникальных пользователей в месяц (MAU) и 170 млн сессий в месяц (~7 визитов на пользователя)
- около 20% пользователей заходят в сервис ежедневно (stickness, DAU/MAU)
- среднее время сессии пользователя - 9 минут
- в среднем пользователь за сессию просматривает около 10 страниц
- bounce rate сервиса - около 25% пользователей покидают сайт, не совершая никаких взаимодействий

## Анализ аудитории

#### География пользователей
![img.png](images/user_geography.png)

#### Устройства пользователей
![img.png](images/devices.png)

## 2. Расчет нагрузки

### Расчет объема сохраняемых данных
В 2024 году [Notion](https://www.notion.com/blog/100-million-of-you) достиг отметки 100 млн пользователей. Исходя из этого можно оценить объем сохраняемых данных.

| Хранимые данные           | Средний размер единицы | Ед/пользователь | Сколько единиц | Суммарный объем  |
|---------------------------|------------------------|:---------------:|----------------|------------------|
| профиль пользователя      | 300 Кб                 |        1        | 100 млн         | 30 Тб            | 
| страницы (без вложений)   | 200 Кб (~25k слов)                 |       10        | 1 млрд        | 200 Тб           |
| вложения                  | 1 Мб                   |       40        | 4 млрд       | 4 Пб           |

Суммарный объем данных составляет 4230 Тб, из которых 4000 Тб - хранилище вложений.

### Расчет среднего количества действий пользователя в день и RPS
Публичных данных по действиям пользователя в день нет, поэтому я опираюсь на свой опыт использования Notion и агрегированные метрики с [hypestat](https://hypestat.com/info/notion.so). Пользователь в среднем просматривает ~9.5 страниц за сессию. Примем, что у пользователя примерно 4 сессии в день, тогда в среднем это около 38 страниц в день. Эти страницы формируются из нескольких типов действий:
- **посещение домашней страницы** — точка входа, где отображаются список собственных страниц, недавние и избранные;
- **поиск по страницам** — часть навигации, которая открывает нужный документ;
- **просмотры контента** — собственно загрузка страниц с данными и вложениями, кроме домашней.

Для расчета RPS будем использовать формулу

$$RPS = \frac{\text{среднее действий в день на пользователя} \times DAU}{86\,400}$$

| Действие                          | Среднее количество в день на пользователя |   RPS  |
|-----------------------------------|:-----------------------------------------:|-------:|
| посещение домашней страницы       |                    12                     |    707 |
| создание страницы                 |                     1                     |     59 |
| поиск страниц                     |                    6.5                    |    383 |
| регистрация/авторизация           |                    0.1                    |      6 |
| редактирование страницы (явное)   |                    10                     |    589 |
| автосохранение (5 сек, 15 мин)    |                   180                     | 10,598 |
| просмотр страницы                 |                    30                     |  1,766 |
| прикрепление вложений             |                    2.5                    |    147 |
| изменение прав доступа (ACL)      |                    0.6                    |     35 |
| профиль пользователя              |                    0.2                    |     12 |

В результате расчётов получаем средний RPS ≈ 14 300. Для оценки пиков учтем, что пользователи находятся в разных часовых поясах, поэтому пики нагрузки распределены, но всё же заметно превышают среднее значение. Примем коэффициент RPS×2.0 для перехода от среднего к пиковому значению. Итого, расчётная пиковая нагрузка ≈ 28 600 RPS.

### Расчет сетевого трафика

Для оценки сетевой нагрузки можно ориентироваться на замеры в инструментах разработчика браузера (DevTools). Суммарную нагрузку на сеть считаем по формуле:

$$
\text{Нагрузка [Гбит/с]} =
\frac{\text{средний трафик на действие [КБ]} \times RPS \times 8}
{1024 \times 1024}
$$


